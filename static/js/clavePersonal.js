var clavePersonal=function(ll){var l11,l1l;this.initBase=function(){this.l11=new Array();this.l1l=new Array();this.l11['0']=48;this.l11['1']=49;this.l11['2']=50;this.l11['3']=51;this.l11['4']=52;this.l11['5']=53;this.l11['6']=54;this.l11['7']=55;this.l11['8']=56;this.l11['9']=57;this.l11['A']=65;this.l11['C']=67;this.l11['E']=69;this.l11['F']=70;this.l11['H']=72;this.l11['J']=74;this.l11['K']=75;this.l11['L']=76;this.l11['M']=77;this.l11['N']=78;this.l11['P']=80;this.l11['Q']=81;this.l11['R']=82;this.l11['S']=83;this.l11['T']=84;this.l11['U']=85;this.l11['W']=87;this.l11['X']=88;this.l11['Y']=89;this.l11['Z']=90;this.l1l['0']=0;this.l1l['1']=1;this.l1l['2']=2;this.l1l['3']=3;this.l1l['4']=4;this.l1l['5']=5;this.l1l['6']=6;this.l1l['7']=7;this.l1l['8']=8;this.l1l['9']=9;this.l1l['A']=10;this.l1l['C']=11;this.l1l['E']=12;this.l1l['F']=13;this.l1l['H']=14;this.l1l['J']=15;this.l1l['K']=16;this.l1l['L']=17;this.l1l['M']=18;this.l1l['N']=19;this.l1l['P']=20;this.l1l['Q']=21;this.l1l['R']=22;this.l1l['S']=23;this.l1l['T']=24;this.l1l['U']=25;this.l1l['W']=26;this.l1l['X']=27;this.l1l['Y']=28;this.l1l['Z']=29;};var l111=21,clave,generico,productoId,presentacionId,valida,errMsg,errNo,consecutivoLote,tipoClave,valEnProceso,guarEnProceso,estaGuardadaOk,exception;this.setErrMsg=function(l){this.errMsg=l;};this.getErrMsg=function(){return this.errMsg;};this.setErrNo=function(l){this.errNo=l;};this.getErrNo=function(){return this.errNo;};this.setClave=function(l){this.clave=l};this.getClave=function(){return this.clave;};this.setGenerico=function(l){this.generico=l;};this.getGenerico=function(){return this.generico;};this.setTipoClave=function(l){this.tipoClave=l;};this.getTipoClave=function(){return this.tipoClave;};this.setProductoId=function(l){this.productoId=l;};this.getProductoId=function(){return this.productoId;};this.setPresentacionId=function(l){this.presentacionId=l;};this.getPresentacionId=function(){return this.presentacionId;};this.setLote=function(l){this.consecutivoLote=l;};this.getLote=function(){return this.consecutivoLote;};this.esValida=function(){return this.valida;};this.setEsValida=function(l){this.valida=l;};this.clavePersonal=function(l){this.clave=l;this.setErrNo(0);this.setErrMsg("");this.initBase();};this.setGuardandoEnProceso=function(l){this.guarEnProceso=l;};this.guardandoEnProceso=function(){return this.guarEnProceso;};this.setValidacionEnProceso=function(l){this.valEnProceso=l;};this.validacionEnProceso=function(l){return this.valEnProceso;};this.setGuardadaOk=function(l){this.estaGuardadaOk=l;};this.guardadaOk=function(){return this.estaGuardadaOk;};this.setException=function(l){this.exception=l;};this.getException=function(){return this.exception;};this.validar=function(validarGenerico,validarExistencia){this.setErrNo(0);this.setErrMsg("");var tipo=0;var lote=0;this.setEsValida(false);this.setValidacionEnProceso(true);if(this.clave==""){trace("Ingresa una clave personal");this.setErrMsg("Ingresa una clave personal");this.setEsValida(false);this.setValidacionEnProceso(false);}else{trace("tamaño de clave:"+this.clave.length);if(this.clave.length==10){trace("es una clave nueva");if(this.getProductoId()==-1||this.getProductoId()==0||this.getProductoId()==""){trace("validacion Selecciona un producto");this.setErrMsg("Selecciona un producto");this.setEsValida(false);this.setValidacionEnProceso(false);}else if(this.getPresentacionId()==-1||this.getPresentacionId()==0||this.getPresentacionId()==""){trace("validacion el numero de unidades que contiene el producto");this.setErrMsg("Selecciona el numero de unidades que contiene el producto");this.setEsValida(false);this.setValidacionEnProceso(false);}else if(this.validarClaveAlfanumerica()){trace("validacion La clave nueva paso validacion");this.setGenerico(cn_generico + cn_presentacion);this.setLote(cn_generico + cn_presentacion);this.setTipoClave("A");this.setEsValida(true);}else{trace("validacion La clave no es válida. Asegurate que la ingresaste correctamente.");this.setErrMsg("La clave no es válida. Asegurate que la ingresaste correctamente.");this.setEsValida(false);this.setValidacionEnProceso(false);};}else{trace("es una clave vieja");if(this.clave.length==19){trace("es una clave de 19");var tipoPaquete=this.clave.substring(0,1);var restoNumero=this.clave.substring(1,19);this.setClave(tipoPaquete+"00"+restoNumero);};if(this.clave.length!=l111){if(this.clave.length<l111){this.setErrMsg("Te faltan caracteres para que tu clave personal sea válida. Por favor revísala.");this.setEsValida(false);this.setValidacionEnProceso(false);}else{this.setErrMsg("Te sobran caracteres para que tu clave personal sea válida. Por favor revísala.");this.setEsValida(false);this.setValidacionEnProceso(false);};}else{var tipoPaquete=this.clave.substring(0,1).toUpperCase();var maquina=this.clave.substring(1,8);var lote=this.clave.substring(8,11);var codeGenProd=this.clave.substring(11,15);var hora=this.clave.substring(15,17);var minutos=this.clave.substring(17,19);var consecutivo=this.clave.substring(19,21);if(tipoPaquete.toUpperCase()!='P'){trace("validacion El número ingresado no corresponde con un formato válido.("+tipoPaquete.toUpperCase()+")");this.setErrMsg("El número ingresado no corresponde con un formato válido.");this.setEsValida(false);this.setValidacionEnProceso(false);};if(this.getProductoId()==-1||this.getProductoId()==0||this.getProductoId()==""){trace("validacion Selecciona un producto");this.setErrMsg("Selecciona un producto");this.setEsValida(false);this.setValidacionEnProceso(false);}else{if(this.getPresentacionId()==-1||this.getPresentacionId()==0||this.getPresentacionId()==""){trace("validacion el numero de unidades que contiene el producto");this.setErrMsg("Selecciona el numero de unidades que contiene el producto");this.setEsValida(false);this.setValidacionEnProceso(false);}else{trace("verificando clave numerica ....");if(this.validaClaveNumerica(tipoPaquete,maquina,lote,codeGenProd,hora,minutos,consecutivo)){trace("paso verificacion numerica");this.setLote(lote);this.setGenerico(lote);this.setTipoClave("N");this.setEsValida(true);}else{trace("NO paso verificacion numerica");this.setErrMsg("Clave invalida");this.setEsValida(false);this.setValidacionEnProceso(false);};};};};};};};this.validaClaveNumerica=function(tipoPaquete,maquina,lote,codeGenProd,hora,minutos,consecutivo){var men="";var menbool=false;if(maquina.length!=7){menbool=true;}else if((maquina<100) || (maquina>9999999)){menbool=true;};if(!this.esEnteroPositivoDato(maquina)){ menbool=true;};if(lote==-1){menbool=true;}else{while(lote.length<3){lote="0"+lote;};};if(codeGenProd.length!=4){menbool=true;}else{if((codeGenProd<1||codeGenProd>9366)){menbool=true;};if(!this.esEnteroPositivoDato(codeGenProd)){menbool=true;};};if(hora.length!=2){menbool=true;}else{if((hora<0||hora>23)){menbool=true;};};if(!this.esEnteroPositivoDato(hora)){menbool=true;};if(minutos.length!=2){menbool=true;}else{if((minutos<0||minutos>59)){menbool=true;};if(!this.esEnteroPositivoDato(minutos)){menbool=true;};};if(consecutivo.length!=2){menbool=true;}else{if((consecutivo < 0 || consecutivo > 99)){menbool=true;}if(!this.esEnteroPositivoDato(consecutivo)){menbool=true;}};var esValido=this.validarNumeroProducto(codeGenProd);if(!esValido){menbool=true;};if(tipoPaquete!='M'&&tipoPaquete!='P'){menbool=true;};if(menbool){this.setErrMsg("La clave personal que ingresaste no es válida");trace("La clave personal que ingresaste no es válida");return false;}else{this.setClave(tipoPaquete + maquina + "-" + lote + codeGenProd + hora + ":" + minutos + "-" + consecutivo);this.setLote(lote);return true;};};this.validarNumeroProducto=function(numeroProducto){var length=numeroProducto.length;var digitoJul=numeroProducto.substring(1,length);if(digitoJul>366||digitoJul<1||digitoJul==""){return false;};return true;};this.esEnteroPositivoDato=function(dato){if(isNaN(dato)||dato.indexOf(".")!=-1||parseInt(dato,10)<0){return false;};return true;};var c1,c2,c3,c4,f1,f2,cn_linea,cn_generico,cn_presentacion,cn_v;this.descomponer1=function(clave){c1=clave.substring(0,1);c2=clave.substring(2,3);c3=clave.substring(4,5);c4=clave.substring(7,8);f1=clave.substring(1,2);f2=clave.substring(9,10);cn_linea=clave.substring(3,4);cn_generico=clave.substring(6,7);cn_presentacion=clave.substring(8,9);cn_v=clave.substring(5,6);};this.descomponer2=function(clave){c1=clave.substring(0,1);c2=clave.substring(3,4);c3=clave.substring(5,6);c4=clave.substring(7,8);f1=clave.substring(4,5);f2=clave.substring(8,9);cn_linea=clave.substring(9,10);cn_generico=clave.substring(1,2);cn_presentacion=clave.substring(6,7);cn_v=clave.substring(2,3);};this.descomponer3=function(clave){c1=clave.substring(0,1);c2=clave.substring(2,3);c3=clave.substring(4,5);c4=clave.substring(6,7);f1=clave.substring(5,6);f2=clave.substring(9,10);cn_linea=clave.substring(1,2);cn_generico=clave.substring(8,9);cn_presentacion=clave.substring(3,4);cn_v=clave.substring(7,8);};this.calcularVal=function(){var suma=new Number(0);suma=Number(this.l11[c1])*1+Number(this.l11[c2])*2+Number(this.l11[c3])*3+Number(this.l11[c4])*5+Number(this.l11[f1])*7+Number(this.l11[f2])*11+Number(this.l11[cn_linea])*13+Number(this.l11[cn_generico])*17+Number(this.l11[cn_presentacion])*19;var mod = Number(suma%30);var verificador;if(mod==0){verificador=0;}else{verificador=Number(30-mod);};return verificador;};this.remplazarCaracteres = function(texto){texto=texto.toUpperCase();texto=this.replaceIt(texto,"B","8");texto=this.replaceIt(texto,"V","U");texto=this.replaceIt(texto,"D","0");texto=this.replaceIt(texto,"O","0");texto=this.replaceIt(texto,"G","6");texto=this.replaceIt(texto,"I","1");return texto;};this.replaceIt=function(sString, sReplaceThis, sWithThis){if(sReplaceThis!=""&&sReplaceThis!=sWithThis){var counter=0;start=0;before="";after="";while(counter<sString.length){start=sString.indexOf(sReplaceThis,counter);if(start == -1){break;}else{before=sString.substr(0,start);after=sString.substr(start+sReplaceThis.length,sString.length);sString=before+sWithThis+after;counter=before.length+sWithThis.length;};};};return sString;};this.validarClaveAlfanumerica=function(){this.setErrNo(0);this.setErrMsg("");clave=this.getClave();clave=clave.toUpperCase();clave=this.remplazarCaracteres(clave);if(clave.length == 10){var primerDigito=clave.substring(0,1);if(this.l11[primerDigito]>=this.l11['0']&&this.l11[primerDigito]<this.l11['A']){this.descomponer1(clave);}else{if(this.l11[primerDigito]>=this.l11['A']&&this.l11[primerDigito]<this.l11['N']){this.descomponer2(clave);}else{if(this.l11[primerDigito]>=this.l11['N']&&this.l11[primerDigito]<=this.l11['Z']){this.descomponer3(clave);}else{trace("validacion Clave invalida");this.setErrMsg("Clave invalida");return false;};};};trace(this.calcularVal()+"=="+this.l1l[cn_v]);if(this.calcularVal()==this.l1l[cn_v]){return true;}else{return false;};};};this.genericoConcuerda = function(){};this.validarExiste = function(){};this.guardar = function(actividad){};this.clavePersonal(ll);};function trace(msg){/*alert(msg);*/};

//$(document).ready(function() {
//    var clave = new clavePersonal("P10212171103210234734"); //<-- clave antigua
//    var clave = new clavePersonal("NCCKI04ZNY"); //<-- clave nueva
//    clave.validar();
//    if(clave.esValida()) alert("Clave OK, generico: "+clave.getGenerico());
//    else alert("Error:"+clave.getErrMsg());
//    })
